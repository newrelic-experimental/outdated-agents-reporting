## Multi Agent Outdated Report - Data is fetched, formatted, and reported for each agent type or domain separately and sent in a single email with all reports attached
## This template is most useful if you have a large amount of entities
## See AGENTS variable in outdated_agents.js for all possible agentTypes or domains available to report on

name: outdated_agents_multiple_nrql
description: 'Queries outdated agents by agent type and sends a single email with all CSV reports attached'
workflowInputs:
  emailDestinationId:
    type: String
    defaultValue: ''
    validations:
      - type: regex
        errorMessage: destinationId must be a valid UUID
        pattern: ^[a-fA-F0-9]{8}-([a-fA-F0-9]{4}-){3}[a-fA-F0-9]{12}$
    required: true
  accountId:
    type: Int
    defaultValue: 1
    validations: []
    required: true
steps:
  # Send single email with multiple attachements (one per agentType/query)
  - name: sendReport
    type: action
    action: newrelic.notification.sendEmail
    version: 1
    inputs:
      destinationId: ${{ .workflowInputs.emailDestinationId }}
      subject: New Relic Outdated Agents Report
      message: >-
        This is an automated report generated from New Relic.
        See attached CSVs for lists of current outdated agents by type.
      attachments:
        - name: outdated_agents_apm
          type: QUERY
          query: "FROM OutdatedAgents SELECT latest(accountName) as 'account', latest(account_id) as 'accountId', latest(agentType) as 'agentType', latest(entityName) as 'entity', latest(currentVersion) as 'currentVersion', latest(currentVersionAgeInDays) as 'currentVersionAgeInDays', latest(latestVersion) as 'latestVersion', latest(team) as 'team' WHERE domain = 'APM' FACET entityGuid as 'guid' SINCE 1 day ago LIMIT MAX"
          format: CSV
          filename: outdated_agents_apm.csv
        - name: outdated_agents_infra
          type: QUERY
          query: "FROM OutdatedAgents SELECT latest(accountName) as 'account', latest(account_id) as 'accountId', latest(agentType) as 'agentType', latest(entityName) as 'entity', latest(currentVersion) as 'currentVersion', latest(currentVersionAgeInDays) as 'currentVersionAgeInDays', latest(latestVersion) as 'latestVersion', latest(team) as 'team' WHERE agentType = 'INFRASTRUCTURE' FACET entityGuid as 'guid' SINCE 1 day ago LIMIT MAX"
          format: CSV
          filename: outdated_agents_infra.csv
        - name: outdated_agents_browser
          type: QUERY
          query: "FROM OutdatedAgents SELECT latest(accountName) as 'account', latest(account_id) as 'accountId', latest(agentType) as 'agentType', latest(entityName) as 'entity', latest(currentVersion) as 'currentVersion', latest(currentVersionAgeInDays) as 'currentVersionAgeInDays', latest(latestVersion) as 'latestVersion', latest(team) as 'team' WHERE agentType = 'BROWSER' FACET entityGuid as 'guid' SINCE 1 day ago LIMIT MAX"
          format: CSV
          filename: outdated_agents_browser.csv
        - name: outdated_agents_mobile
          type: QUERY
          query: "FROM OutdatedAgents SELECT latest(accountName) as 'account', latest(account_id) as 'accountId', latest(agentType) as 'agentType', latest(entityName) as 'entity', latest(currentVersion) as 'currentVersion', latest(currentVersionAgeInDays) as 'currentVersionAgeInDays', latest(latestVersion) as 'latestVersion', latest(team) as 'team' WHERE domain = 'MOBILE' FACET entityGuid as 'guid' SINCE 1 day ago LIMIT MAX"
          format: CSV
          filename: outdated_agents_mobile.csv
    next: end
